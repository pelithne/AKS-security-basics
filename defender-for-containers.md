# Defender for Containers


## Introduction

Microsoft Defender for Containers is a cloud-native solution that helps you secure your containers and their applications. It protects your Kubernetes clusters from misconfigurations, vulnerabilities, and threats, whether they are running on Azure, AWS, GCP, or on-premises. With Microsoft Defender for Containers, you can:

- Harden your environment by continuously monitoring your cluster configurations and applying best practices.
- Assess your container images for known vulnerabilities and get recommendations to fix them.
- Protect your nodes and clusters from run-time attacks and get alerts for suspicious activities.
- Discover your data plane components and get insights into your Kubernetes and environment configuration.

Microsoft Defender for Containers is part of Microsoft Defender for Cloud, a comprehensive security solution that covers your cloud workloads and hybrid environments. You can enable it easily from the Azure portal and start improving your container security today. Learn more about Microsoft Defender for Containers from [this article](https://learn.microsoft.com/en-us/azure/defender-for-cloud/defender-for-containers-introduction).

## Prerequisites

Make sure you have enabled Microsoft Defender for Container before you follow these steps. You can find out how to do this in the [Enable Microsoft Defender for Containers](https://github.com/pelithne/AKS-security-basics/blob/main/Identity-and-access-mgmt.md#23-enable-microsoft-defender-for-containers) section. 

During this activity you will:

* Scan Container images for vulnerabilities.
* Threat hunting for vulnerabilities in your AKS cluster.

Import the metasploit vulnerability emulator docker image from Docker Hub to your Azure container registry.

## Generate a Security Alert for Kubernetes Workload


Launch a pod that executes a test command, to simulate a security alert in Microsoft Defender for cloud.

Create a blank file with the following command.

````bash
touch mdctest.yaml
````

Fill the file with this Yaml manifest, which will launch a pod named mdc-test with ubuntu version 18.04 as container image.

````bash
apiVersion: v1
kind: Pod
metadata:
    name: mdc-test
spec:
    containers:
        - name: mdc-test
          image: ubuntu:18.04
          command: ["/bin/sh"]
          args: ["-c", "while true; do echo sleeping; sleep 9600;done"]

````
Apply the configuration in the file mdctest.yaml. this will essentially create a Pod in the namespace default.

````bash
kubectl apply -f mdctest.yaml
````

Verify that the Pod is in a running state:

````bash
kubectl get pods 
````

Example output:

````bash
NAME       READY   STATUS    RESTARTS   AGE
mdc-test   1/1     Running   0          8s
````
Lets run a bash shell inside the container named **mdc-test**. The bash shell is a common command-line interface that allows you to run various commands and scripts. To do this, we use the following command:

````bash
kubectl exec -it mdc-test -- bash
````
We now whant to copy and run the echo binary, which is a program which prints its arguments to the standard output. this is useful for testing the security alert system in Microsoft Defender for Cloud.

Copy the echo binary to a file named asc_alerttest_662jfi039n in the current working directory.

````bash
cp /bin/echo ./asc_alerttest_662jfi039n
````
Execute the echo binary and print "testing eicar pipe" to the standard out.

````bash
./asc_alerttest_662jfi039n testing eicar pipe
````
Example output:

````bash
mdc@mdc-test: ./asc_alerttest_662jfi039n testing eicar pipe
testing eicar pipe
````
Verify that Microsoft defender has triggered a security alert in Microsoft Defender for Cloud.

1) Go to https://portal.azure.com in your browser and log in if needed.

2) Once you have successfully logged in to Azure, Type in **Microsoft Defender for Cloud** in the search field. 
3) From the drop down menu click on  **Microsoft Defender for Cloud**.

![Screenshot](/images/mdc-step1.png)

4) On your left hand side menu, under **General** section click on **Security alerts**.

5) You should now see the Security alert, generated by Microsoft Cloud Defender. Click on the **Alert**. 

![Screenshot](/images/mdc-step-asc-1.png)

6) Review the security assessment by clicking on **View full details**.

7) Once you have reviewed the details of the simulated security alert. Put the status of the alert from **Active** to **Resolved**. The security alert will dissapear from the security alert list.

![Screenshot](/images/mdc-step-asc-1-2.png)

8) Delete the running pod from the AKS cluster

````bash
kubectl delete pods mdc-test
````

## Import Vulnerable image to Container Registry

````bash
az acr import --name $ACRNAME --source docker.io/vulnerables/metasploit-vulnerability-emulator
````
Verify that the docker image is stored in your container registry.

````bash
az acr repository list --name $ACRNAME
````

## Review Microsoft Defender for Containers Assessments
